<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用 | Mobius</title><meta name="author" content="Mobius Wu"><meta name="copyright" content="Mobius Wu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用職責練模式這篇會用到職責練模式的概念，但不會從頭講解職責練模式，如果對於這個設計模式還不熟悉，建議先理解一下再來閱讀會對理解上比較有幫助一些 職責練模式 （可以參考這邊） 用簡單又較為口語化的方式來敘述職責練模式來說，我們讓一個處理的過程拆解成像是一個產線的感覺，這一站處理完換下一站處理，每一站都可以">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用">
<meta property="og:url" content="https://dopamine908.github.io/2021/01/21/Laravel/Pipeline/index.html">
<meta property="og:site_name" content="Mobius">
<meta property="og:description" content="Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用職責練模式這篇會用到職責練模式的概念，但不會從頭講解職責練模式，如果對於這個設計模式還不熟悉，建議先理解一下再來閱讀會對理解上比較有幫助一些 職責練模式 （可以參考這邊） 用簡單又較為口語化的方式來敘述職責練模式來說，我們讓一個處理的過程拆解成像是一個產線的感覺，這一站處理完換下一站處理，每一站都可以">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://picsum.photos/id/660/800/600">
<meta property="article:published_time" content="2021-01-21T14:25:44.000Z">
<meta property="article:modified_time" content="2023-07-28T12:32:56.234Z">
<meta property="article:author" content="Mobius Wu">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="Pipeline">
<meta property="article:tag" content="Middleware">
<meta property="article:tag" content="Query">
<meta property="article:tag" content="Design Pattern">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picsum.photos/id/660/800/600"><link rel="shortcut icon" href="/img/mobius_stripe.png"><link rel="canonical" href="https://dopamine908.github.io/2021/01/21/Laravel/Pipeline/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-28 12:32:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/mobius_stripe.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Mobius"><span class="site-name">Mobius</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2021-01-21T14:25:44.000Z" title="Created 2021-01-21 14:25:44">2021-01-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Laravel/">Laravel</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Laravel-中的職責鏈模式-Middleware-背後的魔法-及-在-Query-上的應用"><a href="#Laravel-中的職責鏈模式-Middleware-背後的魔法-及-在-Query-上的應用" class="headerlink" title="Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用"></a>Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用</h1><h2 id="職責練模式"><a href="#職責練模式" class="headerlink" title="職責練模式"></a>職責練模式</h2><p>這篇會用到職責練模式的概念，但不會從頭講解職責練模式，如果對於這個設計模式還不熟悉，建議先理解一下再來閱讀會對理解上比較有幫助一些</p>
<p><strong>職責練模式</strong> （<a target="_blank" rel="noopener" href="https://refactoring.guru/design-patterns/chain-of-responsibility">可以參考這邊</a>）</p>
<p>用簡單又較為口語化的方式來敘述職責練模式來說，我們讓一個處理的過程拆解成像是一個產線的感覺，這一站處理完換下一站處理，每一站都可以獨自判斷自己該運作或是根據某些條件 pass 給下一站</p>
<p>在設計上會讓大家共同實作某個讓執行者可以執行的介面，例如 <code>handle()</code> ， 底下看一下大致上的示意圖</p>
<p><img src="https://i.imgur.com/KHBXlfD.png"></p>
<p>所以說，為什麼會提到職責練模式呢？</p>
<p>其實，本篇的主角是一個 Laravel 官方文件也沒提及的一個類別，他叫做 Pipeline ，雖然沒有當作一個獨立的功能記載在文件上，但在 Laravel 的生命週期中卻扮演著相當重要的角色，而今天我們就是來試圖去理解它，並且將 Pipeline 獨立應用，看會發生什麼有趣的事情</p>
<h2 id="Laravel-Middleware"><a href="#Laravel-Middleware" class="headerlink" title="Laravel Middleware"></a>Laravel Middleware</h2><p>以下的程式範例會使用 Laravel 官方的 github 上的程式碼，我們將會使用 Laravel 8.0 當作範例</p>
<p><strong>Github Repository 來源</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/tree/v8.0.0">Laravel</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/tree/v8.0.0">Framework</a></li>
</ul>
<p>那麼，在 Laravel 的生命週期中，Pipeline 究竟是扮演著一個什麼樣的角色呢？</p>
<p>我們要先從 Laravel 的生命週期進入點開始一步一步的看中間到底發生了什麼事情</p>
<h3 id="生命週期的進入點-——-index-php"><a href="#生命週期的進入點-——-index-php" class="headerlink" title="生命週期的進入點 —— index.php"></a>生命週期的進入點 —— index.php</h3><p>首先我們看到 <code>public/index.php</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/public/index.php"><strong>public&#x2F;index.php</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Http</span>\<span class="title">Kernel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;LARAVEL_START&#x27;</span>, <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/../storage/framework/maintenance.php&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../storage/framework/maintenance.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span> = <span class="variable">$app</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="title class_">Kernel</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$response</span> = <span class="title function_ invoke__">tap</span>(<span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">handle</span>(</span><br><span class="line">    <span class="variable">$request</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">capture</span>()</span><br><span class="line">))-&gt;<span class="title function_ invoke__">send</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">terminate</span>(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到 14 行的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app = require_once __DIR__.&#x27;/../bootstrap/app.php&#x27;;</span><br></pre></td></tr></table></figure>
<p>這邊將 Laravel 整個應用程式給載入進來，設定為 <code>$app</code></p>
<p>接著在 16 行的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Kernel::class);</span><br></pre></td></tr></table></figure>

<p>這邊將 Laravel 運行的核心 ： <code>Kernel::class</code> 設定成 <code>$kernel</code></p>
<p>而這個 <code>$kernel</code> 的實體則是 <a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/app/Http/Kernel.php"><code>app/Http/Kernel.php</code></a><br>這部分是因為在 <a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/public/index.php">index.php</a> 中所使用的 <code>Kernel::class</code> 的來源就是在上方 use 的 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Contracts/Http/Kernel.php"><code>Illuminate\Contracts\Http\Kernel</code></a> ，但是 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Contracts/Http/Kernel.php"><code>Illuminate\Contracts\Http\Kernel</code></a> 其實只是一個介面而已，這時候我們要看到 14 行所提到的 <a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/bootstrap/app.php"><code>bootstrap/app.php</code></a> ，我們可以看到在這裡面有對 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Contracts/Http/Kernel.php"><code>Illuminate\Contracts\Http\Kernel</code></a> 去執行綁定實體的動作，如下方的 7~10 行的位置</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/bootstrap/app.php"><strong>bootstrap&#x2F;app.php</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Foundation\Application</span>(</span><br><span class="line">    <span class="variable">$_ENV</span>[<span class="string">&#x27;APP_BASE_PATH&#x27;</span>] ?? <span class="title function_ invoke__">dirname</span>(<span class="keyword">__DIR__</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Http\Kernel</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Http\Kernel</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Console\Kernel</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Console\Kernel</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span>-&gt;<span class="title function_ invoke__">singleton</span>(</span><br><span class="line">    <span class="title class_">Illuminate\Contracts\Debug\ExceptionHandler</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">App\Exceptions\Handler</span>::<span class="variable language_">class</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$app</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也就是說，在 <a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/public/index.php">public&#x2F;index.php</a> 繼續往下執行到要取得 <code>$response</code> 的時候</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/public/index.php#L51"><strong>public&#x2F;index.php#L51</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$response</span> = <span class="title function_ invoke__">tap</span>(<span class="variable">$kernel</span>-&gt;<span class="title function_ invoke__">handle</span>(</span><br><span class="line">    <span class="variable">$request</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">capture</span>()</span><br><span class="line">))-&gt;<span class="title function_ invoke__">send</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我們會對 <a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/app/Http/Kernel.php"><code>app/Http/Kernel.php</code></a> 去執行一個名為 <code>handle()</code> 的 function</p>
<p>接下來我們要轉換我們關心的目標，我們來看看這個 <code>handle()</code> 做了哪些事情</p>
<h3 id="App-Http-Kernel-php"><a href="#App-Http-Kernel-php" class="headerlink" title="App&#x2F;Http&#x2F;Kernel.php"></a>App&#x2F;Http&#x2F;Kernel.php</h3><p>我們先來看看 App&#x2F;Http&#x2F;Kernel.php 裡面有什麼內容吧</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/app/Http/Kernel.php"><strong>App&#x2F;Http&#x2F;Kernel.php</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Kernel</span> <span class="keyword">as</span> <span class="title">HttpKernel</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kernel</span> <span class="keyword">extends</span> <span class="title">HttpKernel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$middleware</span> = [</span><br><span class="line">        <span class="comment">// \App\Http\Middleware\TrustHosts::class,</span></span><br><span class="line">        <span class="title class_">\App\Http\Middleware\TrustProxies</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Fruitcake\Cors\HandleCors</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\App\Http\Middleware\PreventRequestsDuringMaintenance</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Http\Middleware\ValidatePostSize</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\App\Http\Middleware\TrimStrings</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">\Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull</span>::<span class="variable language_">class</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$middlewareGroups</span> = [</span><br><span class="line">        <span class="string">&#x27;web&#x27;</span> =&gt; [</span><br><span class="line">            <span class="title class_">\App\Http\Middleware\EncryptCookies</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Session\Middleware\StartSession</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="comment">// \Illuminate\Session\Middleware\AuthenticateSession::class,</span></span><br><span class="line">            <span class="title class_">\Illuminate\View\Middleware\ShareErrorsFromSession</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">\App\Http\Middleware\VerifyCsrfToken</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Routing\Middleware\SubstituteBindings</span>::<span class="variable language_">class</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;api&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;throttle:api&#x27;</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Routing\Middleware\SubstituteBindings</span>::<span class="variable language_">class</span>,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [</span><br><span class="line">        <span class="string">&#x27;auth&#x27;</span> =&gt; <span class="title class_">\App\Http\Middleware\Authenticate</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;auth.basic&#x27;</span> =&gt; <span class="title class_">\Illuminate\Auth\Middleware\AuthenticateWithBasicAuth</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;cache.headers&#x27;</span> =&gt; <span class="title class_">\Illuminate\Http\Middleware\SetCacheHeaders</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;can&#x27;</span> =&gt; <span class="title class_">\Illuminate\Auth\Middleware\Authorize</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;guest&#x27;</span> =&gt; <span class="title class_">\App\Http\Middleware\RedirectIfAuthenticated</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;password.confirm&#x27;</span> =&gt; <span class="title class_">\Illuminate\Auth\Middleware\RequirePassword</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;signed&#x27;</span> =&gt; <span class="title class_">\Illuminate\Routing\Middleware\ValidateSignature</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;throttle&#x27;</span> =&gt; <span class="title class_">\Illuminate\Routing\Middleware\ThrottleRequests</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="string">&#x27;verified&#x27;</span> =&gt; <span class="title class_">\Illuminate\Auth\Middleware\EnsureEmailIsVerified</span>::<span class="variable language_">class</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到他只定義了一些關於 middleware 的變數，並沒有看到我們要執行的 handle() ，所以我們往他繼承的父累別去找，果然我們在 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Foundation/Http/Kernel.php">Illuminate\Foundation\Http\Kernel</a> 找到了 handle()</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Foundation/Http/Kernel.php#L105"><strong>Illuminate\Foundation\Http\Kernel#L105</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">enableHttpMethodParameterOverride</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sendRequestThroughRouter</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">reportException</span>(<span class="variable">$e</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$response</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">renderException</span>(<span class="variable">$request</span>, <span class="variable">$e</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app[<span class="string">&#x27;events&#x27;</span>]-&gt;<span class="title function_ invoke__">dispatch</span>(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RequestHandled</span>(<span class="variable">$request</span>, <span class="variable">$response</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們從第 6 行的位置繼續往下追，找一下 <code>sendRequestThroughRouter($request)</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Foundation/Http/Kernel.php#L130"><strong>Illuminate\Foundation\Http\Kernel#L130</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span>(<span class="params"><span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">instance</span>(<span class="string">&#x27;request&#x27;</span>, <span class="variable">$request</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Facade</span>::<span class="title function_ invoke__">clearResolvedInstance</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bootstrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;app))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">shouldSkipMiddleware</span>() ? [] : <span class="variable">$this</span>-&gt;middleware)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">then</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRouter</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到我們的目標了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Foundation/Http/Kernel.php#L138"><strong>Illuminate\Foundation\Http\Kernel#L138</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">Pipeline</span>(<span class="variable language_">$this</span>-&gt;app))</span><br><span class="line">                -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$request</span>)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">through</span>(<span class="variable">$this</span>-&gt;app-&gt;<span class="title function_ invoke__">shouldSkipMiddleware</span>() ? [] : <span class="variable">$this</span>-&gt;middleware)</span><br><span class="line">                -&gt;<span class="title function_ invoke__">then</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">dispatchToRouter</span>());</span><br></pre></td></tr></table></figure>

<p>大致上來解釋一下這邊發生了什麼事情，這裡我們經由 <code>Pipeline</code> 寄送了 <code>$request</code> ，中間我們要經過 <code>$this-&gt;middleware</code> ，最後將 <code>$request</code> 派發到對應的 route 去執行程式，取得 response ，最後就是回傳</p>
<p>在上方我們可以看到 <code>Pipeline</code> 這個類別掌管了從 request 經由 middleware 最後產生 response 的過程，所以說 <code>Pipeline</code> 在 Laravel 框架的生命週期中其實扮演著相當重要的角色，他可以將 request 拿去執行多個 middleware 之後，最後透過執行 <code>dispatchToRouter()</code> 進而取得 response</p>
<p>這部分的 middleware 有自己一套複雜決策的過程，這邊我們省略，但一般的狀況下 <code>$this-&gt;middleware</code> 就會是我們在 <a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/app/Http/Kernel.php#L16">App&#x2F;Http&#x2F;Kernel.php#L16</a> 所宣告的這些 middleware</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/laravel/blob/v8.0.0/app/Http/Kernel.php#L16"><strong>App&#x2F;Http&#x2F;Kernel.php#L16</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$middleware</span> = [</span><br><span class="line">    <span class="comment">// \App\Http\Middleware\TrustHosts::class,</span></span><br><span class="line">    <span class="title class_">\App\Http\Middleware\TrustProxies</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Fruitcake\Cors\HandleCors</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\App\Http\Middleware\PreventRequestsDuringMaintenance</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Http\Middleware\ValidatePostSize</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\App\Http\Middleware\TrimStrings</span>::<span class="variable language_">class</span>,</span><br><span class="line">    <span class="title class_">\Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull</span>::<span class="variable language_">class</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h2 id="What’s-Pipeline"><a href="#What’s-Pipeline" class="headerlink" title="What’s Pipeline"></a>What’s Pipeline</h2><p>在探討什麼是 Pipeline 之前，我們先來看一個實際上使用 Pipeline 的例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pipeline</span> = <span class="title function_ invoke__">app</span>(<span class="title class_">Pipeline</span>::<span class="variable language_">class</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">send</span>(<span class="variable">$some_instance</span>)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">through</span>(</span><br><span class="line">            [</span><br><span class="line">                <span class="title class_">Step1</span>::<span class="variable language_">class</span>,</span><br><span class="line">                <span class="title class_">Step2</span>::<span class="variable language_">class</span>,</span><br><span class="line">                <span class="title class_">Step3</span>::<span class="variable language_">class</span>,</span><br><span class="line">            ]</span><br><span class="line">        )-&gt;<span class="title function_ invoke__">thenReturn</span>();</span><br></pre></td></tr></table></figure>

<p>接下來我們會針對上面這一段 code 去解析這個過程中間 Pipeline 幫助我們做了什麼事情</p>
<p>首先 Pipeline 原始的 namespace 為 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php"><code>Illuminate\Pipeline\Pipeline</code></a></p>
<p>我們先來介紹幾個等等會用到的參數</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L25"><strong>Illuminate\Pipeline\Pipeline#L25</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The object being passed through the pipeline.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$passable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The array of class pipes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$pipes</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The method to call on each pipe.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$method</span> = <span class="string">&#x27;handle&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$passable</code><ul>
<li>要在這整個過程中傳遞的物件將會被設置在這個變數中(以上面的例子來說就是指 <code>$some_instance</code>)</li>
</ul>
</li>
<li><code>$pipes</code><ul>
<li>這個變數裡面會放要執行的過程中間的每一個步驟(以上面的例子來說就是<code>Step1::class, Step2::class, Step3::class</code>)</li>
</ul>
</li>
<li><code>$method</code><ul>
<li>原始碼中直接將這個變數定義為 <code>&#39;handle&#39;</code> ，這個其實就是我們在職責練模式中每一個職責鏈物件所共同會去實作的 <code>handle()</code> ，由於這個抽象的 function 名稱可能因人而異，所以雖然預設為 <code>&#39;handle&#39;</code> ，但其實是可以修改設定的</li>
</ul>
</li>
</ul>
<p>接著我們照上面執行的 function 一步一步去看每個步驟做了什麼吧</p>
<p>在我們用 <code>app(Pipeline::class)</code> 將 Pipeline 實體化之後，我們執行了 <code>send($some_instance)</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L58"><strong>send($passable)</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"><span class="variable">$passable</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;passable = <span class="variable">$passable</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡會將我們所帶入的 <code>$some_instance</code> 設置到 <code>$passable</code> 變數中，而這個 <code>$some_instance</code> 就會成為我們在職責鏈模式中傳遞的那個物件</p>
<p>接著我們執行了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-&gt;<span class="title function_ invoke__">through</span>(</span><br><span class="line">    [</span><br><span class="line">        <span class="title class_">Step1</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">Step2</span>::<span class="variable language_">class</span>,</span><br><span class="line">        <span class="title class_">Step3</span>::<span class="variable language_">class</span>,</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>所以我們來看一下 <code>through()</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L71"><strong>through($pipes)</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">through</span>(<span class="params"><span class="variable">$pipes</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;pipes = <span class="title function_ invoke__">is_array</span>(<span class="variable">$pipes</span>) ? <span class="variable">$pipes</span> : <span class="title function_ invoke__">func_get_args</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這邊因為我丟進去的 <code>[Step1::class, Step2::class, Step3::class]</code> 是一個 array ，所以這邊會直接將 <code>$pipes</code> 設置為 <code>[Step1::class, Step2::class, Step3::class]</code>，而 <code>Step1::class, Step2::class, Step3::class</code> 就是職責鏈模式中的職責物件，會去處理被傳遞的那個物件並讓他繼續往後傳遞</p>
<p>接下來執行了最後一個 function ，我們執行了 <code>thenReturn()</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L111"><strong>thenReturn()</strong></a> 、 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L97"><strong>then()</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">thenReturn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">then</span>(function (<span class="variable">$passable</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$passable</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span>(<span class="params"><span class="built_in">Closure</span> <span class="variable">$destination</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$pipeline</span> = <span class="title function_ invoke__">array_reduce</span>(</span><br><span class="line">        <span class="title function_ invoke__">array_reverse</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">pipes</span>()), <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">carry</span>(), <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">prepareDestination</span>(<span class="variable">$destination</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$pipeline</span>(<span class="variable language_">$this</span>-&gt;passable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們可以看到， <code>thenReturn()</code> 最終會去執行 <code>then(Closure $destination)</code> ，而這部分的執行內容有些複雜，但大致上來說就是將我們前面設定好的被傳遞物件 <code>$passable</code> (<code>$some_instance</code>) 拿去讓他在職責物件中(<code>$pipes=[Step1::class, Step2::class, Step3::class]</code>)傳遞並執行，而這個地方比較值得注意的是在上面 code 的第 11 行的 <code>$this-&gt;carry()</code> 內的內容</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L140"><strong>carry()</strong></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">carry</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$stack</span>, <span class="variable">$pipe</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$passable</span></span>) <span class="keyword">use</span> (<span class="params"><span class="variable">$stack</span>, <span class="variable">$pipe</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$pipe</span>)) &#123;</span><br><span class="line">                    <span class="comment">// If the pipe is a callable, then we will call it directly, but otherwise we</span></span><br><span class="line">                    <span class="comment">// will resolve the pipes out of the dependency container and call it with</span></span><br><span class="line">                    <span class="comment">// the appropriate method and arguments, returning the results back out.</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$pipe</span>(<span class="variable">$passable</span>, <span class="variable">$stack</span>);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (! <span class="title function_ invoke__">is_object</span>(<span class="variable">$pipe</span>)) &#123;</span><br><span class="line">                    [<span class="variable">$name</span>, <span class="variable">$parameters</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parsePipeString</span>(<span class="variable">$pipe</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// If the pipe is a string we will parse the string and resolve the class out</span></span><br><span class="line">                    <span class="comment">// of the dependency injection container. We can then build a callable and</span></span><br><span class="line">                    <span class="comment">// execute the pipe function giving in the parameters that are required.</span></span><br><span class="line">                    <span class="variable">$pipe</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getContainer</span>()-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$parameters</span> = <span class="title function_ invoke__">array_merge</span>([<span class="variable">$passable</span>, <span class="variable">$stack</span>], <span class="variable">$parameters</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// If the pipe is already an object we&#x27;ll just make a callable and pass it to</span></span><br><span class="line">                    <span class="comment">// the pipe as-is. There is no need to do any extra parsing and formatting</span></span><br><span class="line">                    <span class="comment">// since the object we&#x27;re given was already a fully instantiated object.</span></span><br><span class="line">                    <span class="variable">$parameters</span> = [<span class="variable">$passable</span>, <span class="variable">$stack</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$carry</span> = <span class="title function_ invoke__">method_exists</span>(<span class="variable">$pipe</span>, <span class="variable">$this</span>-&gt;method)</span><br><span class="line">                                ? <span class="variable">$pipe</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;method&#125;(...<span class="variable">$parameters</span>)</span><br><span class="line">                                : <span class="variable">$pipe</span>(...<span class="variable">$parameters</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handleCarry</span>(<span class="variable">$carry</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">handleException</span>(<span class="variable">$passable</span>, <span class="variable">$e</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這個部分有一點相當值得注意，看到上方的 27 行附近的地方</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$carry</span> = <span class="title function_ invoke__">method_exists</span>(<span class="variable">$pipe</span>, <span class="variable">$this</span>-&gt;method)</span><br><span class="line">            ? <span class="variable">$pipe</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;method&#125;(...<span class="variable">$parameters</span>)</span><br><span class="line">            : <span class="variable">$pipe</span>(...<span class="variable">$parameters</span>);</span><br></pre></td></tr></table></figure>

<p>這個地方設置了關於我們在每個職責物件(<code>$pipes</code>內的元素)需要去執行的 function ，在這邊會先去檢驗 <code>$this-&gt;method</code> 是否正常存在，如果沒有被刻意更改過， <code>$this-&gt;method</code> 在一開始我們是預設為 <code>&#39;handle&#39;</code> 的，所以預設的狀況下， Pipeline 會去執行每個職責物件的 <code>handle()</code></p>
<p>所以在我不改變執行方法的前提下，我必須要讓我的每個職責物件都去實作 <code>handle()</code> 才可以，這方面其實相當類似我們在職責鏈模式中會去提取一個強迫所有職責物件去實作 <code>handle()</code> 的抽象類別或是介面</p>
<p>當然 Laravel 有提供你可以去修改執行的 function 名稱，這部分可以參見 <a target="_blank" rel="noopener" href="https://github.com/laravel/framework/blob/v8.0.0/src/Illuminate/Pipeline/Pipeline.php#L84"><code>via($method)</code></a> 方法</p>
<p>以上大致上介紹了 Pipeline 裡面的內容及運行的整個流程，簡單來說 Pipeline 扮演的就是一個在職責練模式中的 Client 的角色，只是 Laravel 將他封裝的更完整、功能性更齊全、同時也更容易擴展</p>
<p>我們可以傳遞任何的物件讓他流淌於各個職責物件中，同時也可以對於職責物件的先後順序輕易的調換，而且可以將職責物件的共同介面名稱修改的更具表達力，我們只要專注於每一個職責物件內的判斷及實作即可</p>
<h2 id="Run-Query-with-Pipeline"><a href="#Run-Query-with-Pipeline" class="headerlink" title="Run Query with Pipeline"></a>Run Query with Pipeline</h2><p>接著我們來看一個實際的例子，我們來給定一個情境吧</p>
<p>假設我們有一張記載學生的資料表</p>
<p>有幾個主要的欄位</p>
<ul>
<li>名字</li>
<li>性別</li>
<li>居住地</li>
<li>年齡</li>
</ul>
<p>然後假設我們想要對這些學生提供幾種搜尋的方式</p>
<ol>
<li>依照性別搜尋</li>
<li>依照居住地搜尋</li>
<li>依照年齡搜尋</li>
</ol>
<p>以上三種搜尋條件有可能只出現一個，或是出現某兩個，也可能三個條件都具備</p>
<p>首先我們先來為這樣的需求來做點準備吧</p>
<p>先建立 migration</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:migration create_students_table --create=students</span><br></pre></td></tr></table></figure>

<p>在 migration 將欄位設定</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateStudentsTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title class_">Schema</span>::<span class="title function_ invoke__">create</span>(</span><br><span class="line">            <span class="string">&#x27;students&#x27;</span>,</span><br><span class="line">            function (Blueprint <span class="variable">$table</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span>-&gt;<span class="title function_ invoke__">id</span>();</span><br><span class="line">                <span class="variable">$table</span>-&gt;<span class="keyword">string</span>(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">                <span class="variable">$table</span>-&gt;<span class="class"><span class="keyword">enum</span>(&#x27;<span class="title">gender</span>&#x27;, [&#x27;<span class="title">boy</span>&#x27;, &#x27;<span class="title">girl</span>&#x27;]);</span></span><br><span class="line"><span class="class">                $<span class="title">table</span>-&gt;<span class="title">enum</span>(&#x27;<span class="title">area</span>&#x27;, [&#x27;<span class="title">taipei</span>&#x27;, &#x27;<span class="title">tainan</span>&#x27;, &#x27;<span class="title">kaohsiung</span>&#x27;]);</span></span><br><span class="line"><span class="class">                $<span class="title">table</span>-&gt;<span class="title">tinyInteger</span>(&#x27;<span class="title">age</span>&#x27;);</span></span><br><span class="line"><span class="class">                $<span class="title">table</span>-&gt;<span class="title">timestamps</span>();</span></span><br><span class="line"><span class="class">            &#125;</span></span><br><span class="line"><span class="class">        );</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">function</span> <span class="title">down</span>()</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="title class_">Schema</span>::<span class="title function_ invoke__">dropIfExists</span>(<span class="string">&#x27;students&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>設定完之後執行指令建立資料表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure>

<p>接著幫該資料表建立 Model</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:model Students</span><br></pre></td></tr></table></figure>

<p>設定一下 Model</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Models</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Factories</span>\<span class="title">HasFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Students</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HasFactory</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">&#x27;students&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著為生成假資料建立 Factory</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:factory Students</span><br></pre></td></tr></table></figure>

<p>設定 Factory</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Database</span>\<span class="title class_">Factories</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Students</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Factories</span>\<span class="title">Factory</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsFactory</span> <span class="keyword">extends</span> <span class="title">Factory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span> = <span class="title class_">Students</span>::<span class="variable language_">class</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">definition</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;faker-&gt;name,</span><br><span class="line">            <span class="string">&#x27;gender&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;faker-&gt;<span class="title function_ invoke__">randomElement</span>([<span class="string">&#x27;boy&#x27;</span>, <span class="string">&#x27;girl&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;area&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;faker-&gt;<span class="title function_ invoke__">randomElement</span>([<span class="string">&#x27;taipei&#x27;</span>, <span class="string">&#x27;tainan&#x27;</span>, <span class="string">&#x27;kaohsiung&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;age&#x27;</span> =&gt; <span class="variable language_">$this</span>-&gt;faker-&gt;<span class="title function_ invoke__">numberBetween</span>(<span class="variable">$min</span> = <span class="number">10</span>, <span class="variable">$max</span> = <span class="number">20</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 Seeder 中寫入生成假資料的程式碼</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Database</span>\<span class="title class_">Seeders</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Students</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title class_">Students</span>::<span class="title function_ invoke__">factory</span>(<span class="number">100</span>)-&gt;<span class="title function_ invoke__">create</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下指令生成假資料</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan db:seed</span><br></pre></td></tr></table></figure>

<h3 id="一般做法"><a href="#一般做法" class="headerlink" title="一般做法"></a>一般做法</h3><p>接下來我會先寫在一般的狀況下該如何去實作上述的需求，但是我會將關注點放在下搜尋條件這段程式碼上，所以我不會去拆分關於 Repository、Service 之類的架構</p>
<p>首先我在 <code>web.php</code> 內新增我的 router</p>
<p><strong>web.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">StudentsController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Route</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;students&#x27;</span>,[<span class="title class_">StudentsController</span>::<span class="variable language_">class</span>,<span class="string">&#x27;getSearch&#x27;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然後將搜尋的功能寫在 <code>StudentsController</code></p>
<p><strong>StudentsController.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Students</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSearch</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$query_builder</span> = <span class="title class_">Students</span>::<span class="title function_ invoke__">query</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&#x27;gender&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$query_builder</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;gender&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="variable">$request</span>-&gt;gender);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&#x27;area&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$query_builder</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;area&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="variable">$request</span>-&gt;area);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&#x27;age&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$query_builder</span>-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="variable">$request</span>-&gt;age);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$query_builder</span>-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上方的搜尋邏輯應該相當好理解，我去確認有沒有帶該條件，當有條件的時候我就將條件加入到搜尋用的 <code>$query_builder</code> ，最後再將結果取出</p>
<p>類似的事情應該或多或少會出現在你我的搜尋程式碼中，如果我們專注在根據條件加入搜尋的程式碼這件事情上，這樣做其實很明顯的違反了單一職責原則(SRP)，對於決定搜尋的過程來說，至少會有三種不同的因素可以導致這個 function 必須去修改</p>
<p>那麼問題來了，該怎麼辦呢？這樣的狀況又跟我們本篇所要介紹的 Pipeline 又有什麼關聯呢？</p>
<h3 id="Refactor-by-Using-Pipeline"><a href="#Refactor-by-Using-Pipeline" class="headerlink" title="Refactor by Using Pipeline"></a>Refactor by Using Pipeline</h3><p>還記得 Pipeline 帶給我們什麼樣的功能嗎？他讓我們可以定義一條職責鏈，並將某個物件放到這條職責鏈上，讓每個職責物件去處理他，如果遇到不能處理的狀況也可以直接傳遞給下一個職責物件</p>
<p>沒錯，從這樣的功能面上我們有了一個靈感，如果我讓 <code>$query_builder</code> 成為被傳遞的物件，而每一個判斷是否加入新的搜尋條件的邏輯變成職責物件的工作呢？</p>
<p>以下我們開始我們的重構</p>
<p>首先我需要職責物件，而這每一個職責物件必須要有相同的一個 <code>handle()</code> ，所以我先新增一個 interface</p>
<p><strong>IQueryFilter.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">QueryFilter</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IQueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$query_builder</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下來我要讓我的每一個職責物件都去 implements 這個 interface，而我剛剛說我要將每一個判斷是否加入新的搜尋條件的邏輯變成職責物件，所以底下我們新增 3 個職責物件用於判斷是否加入新的搜尋條件</p>
<p><strong>Gender.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">QueryFilter</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gender</span> <span class="keyword">implements</span> <span class="title">IQueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$query_builder</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&#x27;gender&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$query_builder</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;gender&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="title function_ invoke__">request</span>()-&gt;gender);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$query_builder</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Area.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">QueryFilter</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Area</span> <span class="keyword">implements</span> <span class="title">IQueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$query_builder</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&#x27;area&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$query_builder</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;area&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="title function_ invoke__">request</span>()-&gt;area);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$query_builder</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Age.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">QueryFilter</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Age</span> <span class="keyword">implements</span> <span class="title">IQueryFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$query_builder</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&#x27;age&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$query_builder</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="title function_ invoke__">request</span>()-&gt;age);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$query_builder</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊大致上就是三個把判斷條件獨立出來放到各別的職責物件內，當某個搜尋的條件存在的時候，我們就將需要傳遞的物件加上條件，然後繼續往下傳遞</p>
<p>我們將職責物件給製作完了，接下來我們要來改寫 <code>StudentsController</code> 內的 <code>getSearch(Request $request)</code></p>
<p><strong>StudentsController.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Students</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">QueryFilter</span>\<span class="title">Age</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">QueryFilter</span>\<span class="title">Area</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">QueryFilter</span>\<span class="title">Gender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Pipeline</span>\<span class="title">Pipeline</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSearch</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$pipeline</span> = <span class="title function_ invoke__">app</span>(<span class="title class_">Pipeline</span>::<span class="variable language_">class</span>)</span><br><span class="line">            -&gt;<span class="title function_ invoke__">send</span>(<span class="title class_">Students</span>::<span class="title function_ invoke__">query</span>())</span><br><span class="line">            -&gt;<span class="title function_ invoke__">through</span>(</span><br><span class="line">                [</span><br><span class="line">                    <span class="title class_">Gender</span>::<span class="variable language_">class</span>,</span><br><span class="line">                    <span class="title class_">Area</span>::<span class="variable language_">class</span>,</span><br><span class="line">                    <span class="title class_">Age</span>::<span class="variable language_">class</span></span><br><span class="line">                ]</span><br><span class="line">            )-&gt;<span class="title function_ invoke__">thenReturn</span>();</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$pipeline</span>-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣就完成了，我們將所有的條件判斷拆分成各個職責物件，並用 Pipeline 與職責鏈模式的概念去改寫了原本的流程，同樣的，在根據條件加入搜尋的程式碼這件事情上，符合了單一職責原則，我們讓決定搜尋條件的過程本身獨立了出來，決定搜尋條件的判斷也獨立了出來</p>
<p>今天如果我要增加或是刪減某個搜尋條件，我只要將 Pipeline 中間的職責物件新增或移除即可</p>
<p>同樣的如果我要更改某個搜尋條件，例如我想把年齡的條件改為輸入某個數字則可以取得大於該年齡的學生的話，我們也只要專注在修改年齡搜尋的職責物件上就可以</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://refactoring.guru/design-patterns/chain-of-responsibility">https://refactoring.guru/design-patterns/chain-of-responsibility</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7XqEJO-wt7s&ab_channel=Coder%27sTape">https://www.youtube.com/watch?v=7XqEJO-wt7s&amp;ab_channel=Coder%27sTape</a></li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a><a class="post-meta__tags" href="/tags/Laravel/">Laravel</a><a class="post-meta__tags" href="/tags/Pipeline/">Pipeline</a><a class="post-meta__tags" href="/tags/Middleware/">Middleware</a><a class="post-meta__tags" href="/tags/Query/">Query</a><a class="post-meta__tags" href="/tags/Design-Pattern/">Design Pattern</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/mobius_stripe.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mobius Wu</div><div class="author-info__description">Laziness, Impatience and Hubris</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dopamine908"><i class="fab fa-github"></i><span>My Github</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Laravel-%E4%B8%AD%E7%9A%84%E8%81%B7%E8%B2%AC%E9%8F%88%E6%A8%A1%E5%BC%8F-Middleware-%E8%83%8C%E5%BE%8C%E7%9A%84%E9%AD%94%E6%B3%95-%E5%8F%8A-%E5%9C%A8-Query-%E4%B8%8A%E7%9A%84%E6%87%89%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Laravel 中的職責鏈模式 - Middleware 背後的魔法 及 在 Query 上的應用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%B7%E8%B2%AC%E7%B7%B4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">職責練模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Laravel-Middleware"><span class="toc-number">1.2.</span> <span class="toc-text">Laravel Middleware</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F%E7%9A%84%E9%80%B2%E5%85%A5%E9%BB%9E-%E2%80%94%E2%80%94-index-php"><span class="toc-number">1.2.1.</span> <span class="toc-text">生命週期的進入點 —— index.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#App-Http-Kernel-php"><span class="toc-number">1.2.2.</span> <span class="toc-text">App&#x2F;Http&#x2F;Kernel.php</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What%E2%80%99s-Pipeline"><span class="toc-number">1.3.</span> <span class="toc-text">What’s Pipeline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-Query-with-Pipeline"><span class="toc-number">1.4.</span> <span class="toc-text">Run Query with Pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%88%AC%E5%81%9A%E6%B3%95"><span class="toc-number">1.4.1.</span> <span class="toc-text">一般做法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Refactor-by-Using-Pipeline"><span class="toc-number">1.4.2.</span> <span class="toc-text">Refactor by Using Pipeline</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.5.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Mobius Wu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>